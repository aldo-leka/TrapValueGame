@page "/game"
@using TrapValueGame.Services
@using TrapValueGame.Models
@inject GameStateService GameState
@implements IDisposable

<PageTitle>Trap Or Value - Play</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @switch (GameState.CurrentState)
    {
        case Services.GameState.Loading:
            <LoadingState />
            break;

        case Services.GameState.Analyzing:
            <AnalyzingState
                Snapshot="@GameState.CurrentSnapshot"
                NarrativeState="@GameState.NarrativeState"
                Narrative="@GameState.GeneratedNarrative"
                OnDecision="HandleDecision" />
            break;

        case Services.GameState.Revealing:
            <RevealingState Choice="@GameState.PlayerChoice" />
            break;

        case Services.GameState.Result:
            <ResultState
                Reveal="GameState.CurrentReveal"
                TotalPlayed="GameState.TotalPlayed"
                CorrectGuesses="GameState.CorrectGuesses"
                TotalHistoricalPlays="GameState.TotalHistoricalPlays"
                OnPlayAgain="HandlePlayAgain"
                OnResetHistory="HandleResetHistory" />
            break;

        case Services.GameState.Error:
            <ErrorState
                Message="@GameState.ErrorMessage"
                OnRetry="HandleRetry"
                OnResetHistory="HandleResetHistory"
                ShowResetOption="@(GameState.TotalHistoricalPlays > 0)" />
            break;
    }
</MudContainer>

@code {
    private bool _initialized;

    protected override void OnInitialized()
    {
        GameState.OnStateChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;

            // Initialize with localStorage data (JS interop now available)
            await GameState.InitializeAsync();

            // Now load the first snapshot
            await GameState.LoadNextSnapshotAsync();
        }
    }

    private async Task HandleDecision(string choice)
    {
        await GameState.MakeDecisionAsync(choice);
    }

    private async Task HandlePlayAgain()
    {
        await GameState.PlayAgainAsync();
    }

    private async Task HandleRetry()
    {
        await GameState.LoadNextSnapshotAsync();
    }

    private async Task HandleResetHistory()
    {
        await GameState.ResetHistoryAsync();
        await GameState.LoadNextSnapshotAsync();
    }

    public void Dispose()
    {
        GameState.OnStateChanged -= StateHasChanged;
    }
}
